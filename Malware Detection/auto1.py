#!/usr/bin/python

from scapy.all import *
import netifaces
import socket
import time
import json
import urllib

my_ip = netifaces.ifaddresses('wlp2s0')[netifaces.AF_INET][0]['addr']


class Millenium_Falcon(object):

    def __init__(self,key):

        self.key  = key
    
    def client(self,msg):

        client = socket.socket()
        client.connect(('localhost',12345))
        client.send(msg)

      
    def auto(self,packet):

        if packet.haslayer(IP):
            if packet[IP].src == my_ip:
                with open("/root/Python/blackhat/Malware/Detection/ip_check","a") as fobj:
                    fobj.write(packet[IP].dst+"\n")
                    
            
    def report(self):

        url = "https://www.virustotal.com/vtapi/v2/ip-address/report"
        with open("/root/Python/blackhat/Malware/Detection/ip_check",'rb') as fobj:
            lines = fobj.read().splitlines()
            lines = list(set(lines))

        print "[*] Sending four packets every 60 seconds..."
        print
           
        for i in range(0,len(lines)):

            try:
                parameters = {'ip':lines[i], 'apikey': self.key}
                response = urllib.urlopen('%s?%s' % (url, urllib.urlencode(parameters))).read()
                response_dict = json.loads(response)
            
            except:
                print "[!] Waiting 60 seconds..."
                print
                time.sleep(60)
                i = i-1
                continue
                        
            else:
                try:


                    for key,value in response_dict.items():
                        if key == "detected_urls" and value[0]["positives"] > 0:

                            self.client("WARNING!!! Malicious IP: " + lines[i])
                            with open("/home/binyamin/Desktop/malicious_ips",'a') as fobj:
                                fobj.write(lines[i]+"\n")
                                
                        

                except:

                    continue


class DeathStar(Millenium_Falcon):
    def __init__(self,key):
       super(DeathStar,self).__init__(key)
      
        
    def packets(self,manual):
        
        print "[*] Processing pcap file now..."
        print

        y = rdpcap(manual)
        sessions = y.sessions()
        for session in sessions:
            for packet in sessions[session]:

                if packet.haslayer(IP):
                    
                    with open("ip_check1",'a') as fobj:
                        fobj.write(packet[IP].dst+"\n")

    def report(self):

        url="https://www.virustotal.com/vtapi/v2/ip-address/report"
        with open("ip_check1",'rb') as fobj:
            lines = fobj.read().splitlines()
            lines = list(set(lines))
                
        print "[*] Sending four packets every 60 seconds..."
        print
                     
        for i in range(0,len(lines)):

            try:
                parameters = {'ip':lines[i], 'apikey': self.key}
                response = urllib.urlopen('%s?%s' % (url, urllib.urlencode(parameters))).read()
                response_dict = json.loads(response)
            
            except:
                print "[!] Waiting 60 seconds..."
                print
                time.sleep(60)
                i = i-1
                continue
                        
            else:

                try:
                    

                    for key,value in response_dict.items():
                        if key == "detected_urls" and value[0]["positives"] > 0:
                            self.client("WARNING!!! Malicious IP: " + lines[i])
                            with open("/home/binyamin/Desktop/malicious_ips",'a') as fobj:
                                fobj.write(lines[i]+"\n")
                                continue
                        else:
                            continue

                except:

                    continue







